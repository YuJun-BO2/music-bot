services:
  music-bot:
    image: ghcr.io/yujun-bo2/music-bot:latest
    container_name: music-bot
    restart: unless-stopped
    
    # 容器啟動命令 - 複製cookies並啟動機器人
    command: >
      sh -c "
        mkdir -p /app/cookies &&
        if [ -f /app/host_files/youtube_cookies.txt ]; then
          cp /app/host_files/youtube_cookies.txt /app/cookies/youtube_cookies.txt &&
          chmod 600 /app/cookies/youtube_cookies.txt &&
          echo '✅ Cookies文件已複製';
        else
          echo '⚠️ 找不到cookies文件';
        fi &&
        python main.py
      "
    
    # 環境變數設定（由 GitHub Actions 自動注入）
    environment:
      - DISCORD_TOKEN=${DISCORD_TOKEN}
      - COMMAND_PREFIX=${COMMAND_PREFIX:-/}
      - MAX_QUEUE_SIZE=${MAX_QUEUE_SIZE:-100}
      - MAX_HISTORY_SIZE=${MAX_HISTORY_SIZE:-50}
      - EXTRACT_TIMEOUT=${EXTRACT_TIMEOUT:-30}
      - KEEPALIVE_INTERVAL=${KEEPALIVE_INTERVAL:-240}
      - SSH_HOST=${SSH_HOST:-}
      - SSH_PORT=${SSH_PORT:-22}
      - SSH_USER=${SSH_USER:-}
      - SSH_KEY_FILE=${SSH_KEY_FILE:-}
      - ALLOWED_IDS=${ALLOWED_IDS:-}
      - STATE_FILE=/app/data/bot_state.json
      - LOG_FILE=/app/logs/musicbot.log
      # YouTube Cookies 設定 (從容器內複製的位置讀取)
      - YOUTUBE_COOKIES_FILE=/app/cookies/youtube_cookies.txt
      - YOUTUBE_COOKIES_CONTENT=${YOUTUBE_COOKIES_CONTENT:-}
    
    # 數據持久化和SSH密鑰掛載
    volumes:
      - bot_data:/app/data
      - bot_logs:/app/logs
      - ./ssh_key:/app/ssh_key:ro
      # YouTube Cookies 掛載 (直接掛載cookies檔案)
      - /home/deploy/discord-music-bot/youtube_cookies.txt:/app/host_files/youtube_cookies.txt:ro
    
    # 網絡設定（如果需要）
    # networks:
    #   - bot_network
    
    # 健康檢查
    healthcheck:
      test: ["CMD", "python", "-c", "import os; exit(0 if os.path.exists('/app/data/bot_state.json') else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# 數據卷
volumes:
  bot_data:
    driver: local
  bot_logs:
    driver: local

# 網絡（如果需要）
# networks:
#   bot_network:
#     driver: bridge